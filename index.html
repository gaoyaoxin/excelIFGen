<!DOCTYPE html>
<html>
<head>
    <title>Excel IF公式生成器</title>
    <style>
        body{font-family:Arial,sans-serif;margin:20px;background:#f5f5f5;color:#333}
        .container{max-width:800px;margin:0 auto;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
        h1{color:#2c3e50;text-align:center;margin-bottom:25px}
        label{display:block;margin-bottom:8px;font-weight:600}
        input,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:14px;box-sizing:border-box}
        textarea{height:150px;font-family:monospace;resize:vertical}
        button{background-color:#3498db;color:white;padding:12px 24px;border:none;border-radius:4px;cursor:pointer;font-size:16px;font-weight:600;margin-top:10px}
        button:hover{background-color:#2980b9}
        .output-section{margin-top:30px}
        .output-box{margin-bottom:20px;border:1px solid #e0e0e0;border-radius:4px;overflow:hidden}
        .output-header{display:flex;justify-content:space-between;align-items:center;background-color:#f8f9fa;padding:10px 15px;border-bottom:1px solid #e0e0e0}
        .output-header span{font-weight:600}
        .copy-btn{padding:6px 12px;font-size:14px;background-color:#27ae60;margin:0}
        .copy-btn:hover{background-color:#219653}
        .formula-output{padding:15px;background-color:#f8f9fa;font-family:monospace;white-space:pre-wrap;word-break:break-all;min-height:60px}
        .instructions{background-color:#f0f7ff;padding:15px;border-radius:4px;margin-bottom:20px;font-size:14px}
        .instructions h3{margin-top:0;color:#2c3e50}
        .button-group{display:flex;gap:10px}
        .button-group button{flex:1}
        #regenerateBtn{background-color:#f39c12}
        #regenerateBtn:hover{background-color:#e67e22}
    </style>
</head>
<body>
    <div class="container">
        <h1>Excel IF公式生成器</h1>

        <div class="input-section">
            <label for="excelData">Excel数据（ABC三列，无表头）：</label>
            <textarea id="excelData" placeholder="点击下方按钮自动从剪贴板粘贴数据"></textarea>
            
            <label for="targetCell" style="margin-top:15px;">以哪个单元格的条件进行判断？</label>
            <input type="text" id="targetCell" value="F2">
            
            <div class="button-group">
                <button id="pasteGenerateBtn">粘贴&生成</button>
                <button id="regenerateBtn">按现有数据重新生成</button>
            </div>
        </div>
        
        <div class="output-section">
            <div class="output-box">
                <div class="output-header">
                    <span>B列为值</span>
                    <button class="copy-btn" data-target="output1">复制</button>
                </div>
                <div id="output1" class="formula-output">生成的IF公式将显示在这里</div>
            </div>
            
            <div class="output-box">
                <div class="output-header">
                    <span>C列为值</span>
                    <button class="copy-btn" data-target="output2">复制</button>
                </div>
                <div id="output2" class="formula-output">生成的IF公式将显示在这里</div>
            </div>
        </div>

        <div class="instructions">
            <h3>使用说明：</h3>
            <h3>使用前请确保已获合法授权。</h3>
            <p>1. 从Excel复制ABC三列数据（无表头）</p>
            <p>2. 修改目标单元格（如C5）或使用默认值</p>
            <p>3. 点击"粘贴&生成"按钮将自动填充数据和生成公式</p>
            <p>4. 点击"按现有数据重新生成"按钮可重新生成公式</p>
            <p>5. 点击"复制"按钮复制公式</p>
        </div>
        
    </div>

    <script>
        document.getElementById('pasteGenerateBtn').addEventListener('click', async function() {
            // 尝试从剪贴板读取数据
            try {
                const clipboardText = await navigator.clipboard.readText();
                if (clipboardText.trim()) {
                    document.getElementById('excelData').value = clipboardText;
                }
            } catch (err) {
                console.log('无法访问剪贴板，使用文本框中的现有数据');
            }
            
            // 生成公式
            generateFormulas();
        });
        
        // 为重新生成按钮添加事件监听
        document.getElementById('regenerateBtn').addEventListener('click', function() {
            generateFormulas();
        });
        
        // 生成公式的主函数
        function generateFormulas() {
            const excelData = document.getElementById('excelData').value.trim();
            const targetCell = document.getElementById('targetCell').value.trim() || 'C5';
            
            if (!excelData) {
                alert('请先复制Excel数据到剪贴板，然后点击"粘贴&生成"按钮');
                return;
            }
            
            try {
                // 解析数据行
                const rows = excelData.split('\n').filter(row => row.trim());
                const conditions = [];
                const valuesB = [];
                const valuesC = [];
                
                rows.forEach(row => {
                    // 分割列，支持制表符和多个空格
                    const cols = row.split(/\t|\s{2,}/).filter(col => col !== '');
                    if (cols.length >= 3) {
                        conditions.push(cols[0].trim());
                        valuesB.push(cols[1].trim());
                        valuesC.push(cols[2].trim());
                    } else if (cols.length === 2) {
                        // 如果只有两列，假设缺少C列
                        conditions.push(cols[0].trim());
                        valuesB.push(cols[1].trim());
                        valuesC.push('');
                    }
                });
                
                if (conditions.length === 0) {
                    alert('未找到有效的三列数据。请确保数据为三列（用制表符或空格分隔）');
                    return;
                }
                
                // 生成B列为值的IF公式
                const ifFormulaB = generateIfFormula(targetCell, conditions, valuesB);
                // 生成C列为值的IF公式
                const ifFormulaC = generateIfFormula(targetCell, conditions, valuesC);
                
                // 显示结果
                document.getElementById('output1').textContent = ifFormulaB;
                document.getElementById('output2').textContent = ifFormulaC;
                
            } catch (error) {
                alert('数据处理出错: ' + error.message);
            }
        }
        
        // 生成IF公式的函数 - 已修正括号问题
        function generateIfFormula(targetCell, conditions, values) {
            if (conditions.length === 0) return '';
            
            let ifFormula = `=IF(${targetCell}="${conditions[0]}","${values[0]}"`;
            
            for (let i = 1; i < conditions.length; i++) {
                ifFormula += `,IF(${targetCell}="${conditions[i]}","${values[i]}"`;
            }
            
            // 修正括号数量
            ifFormula += ',"")' + ')'.repeat(conditions.length - 1);
            return ifFormula;
        }
        
        // 复制按钮事件处理 - 修复复制功能
        document.querySelectorAll('.copy-btn').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const textToCopy = document.getElementById(targetId).textContent;
                
                if (textToCopy && textToCopy !== '生成的IF公式将显示在这里') {
                    // 使用现代剪贴板API
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            showCopyFeedback(this);
                        }).catch(err => {
                            // 如果现代API失败，使用传统方法
                            fallbackCopyText(textToCopy, this);
                        });
                    } else {
                        // 使用传统方法
                        fallbackCopyText(textToCopy, this);
                    }
                }
            });
        });
        
        // 传统复制方法
        function fallbackCopyText(text, button) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopyFeedback(button);
                } else {
                    alert('复制失败，请手动选择文本复制');
                }
            } catch (err) {
                alert('复制失败，请手动选择文本复制');
            }
            
            document.body.removeChild(textArea);
        }
        
        // 显示复制成功反馈
        function showCopyFeedback(button) {
            const originalText = button.textContent;
            const originalColor = button.style.backgroundColor;
            
            button.textContent = '已复制!';
            button.style.backgroundColor = '#2ecc71';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = originalColor || '#27ae60';
            }, 1500);
        }
        
        // 示例数据
        document.getElementById('excelData').value = `苹果  红色  水果\n香蕉  黄色  水果\n胡萝卜  橙色  蔬菜\n牛奶  白色  饮料`;
    </script>
</body>
</html>
